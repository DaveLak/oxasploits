Ext.define('BS350.controller.SDDocsCtrl',
{
  extend: 'BS350.custom.ViewController',

  views: ['SDDocsView'],

  items: [
    {name: 'docsPanel', query: '#docsPanel'},
    {name: 'docData', query: '#docData', actions: {selectionchange: 'itemselected'}},
    {name: 'noSDMsg', query: '#noSDMsg'},
    {name: 'emptyDocDirMsg', query: '#emptyDocDirMsg'},
    {name: 'noDocDirMsg', query: '#noDocDirMsg'},
    {name: 'btnView', query: '#btnView', actions: {click: 'viewItem'}},
    {name: 'btnDownload', query: '#btnDownload', actions: {click: 'downloadItem'}}
  ],

  currItem: null,
  rootPath: null,
  lastFileNum: -1,
  SDMonitoring: false,

  init: function(application) {
  },

  initView: function() {
    this.docStore = this.V.docData.getStore();
    this.rootPath = null;
    this.lastFileNum = -1;
  },

  setPath: function(path) {
    var isRootPath = (path === this.rootPath);
    var fakePath = path.replace(this.rootPath, '');
    this.docStore.load({
      scope: this,
      params: {node: path, back: !isRootPath},
      callback: function() {
        this.V.docsPanel.setTitle(fakePath);
        if (isRootPath && this.docStore.count() === 0) {
          // Empty SD card
          this.V.docsPanel.setVisible(false);
          this.V.emptySDMsg.setVisible(true);
        }
      }
    });
  },

  loadDocs: function() {
    var path = this.rootPath;
    this.docStore.load({
      scope: this,
      params: {node: path},
      callback: function() {
        if (this.rootPath !== null && this.docStore.count() === 0) {
          this.V.emptyDocDirMsg.setVisible(true);
          this.V.docsPanel.setVisible(false);
          this.V.noSDMsg.setVisible(false);
          this.V.noDocDirMsg.setVisible(false);
        }
        else
        {
          this.V.docsPanel.setVisible(true);
          this.V.emptyDocDirMsg.setVisible(false);
          this.V.noSDMsg.setVisible(false);
          this.V.noDocDirMsg.setVisible(false);
        }
      }
    });
  },

  itemselected: function(dataview, items) {
    if (items.length > 0) {
      this.currItem = items[0];
      this.V.btnView.setDisabled(false);
      this.V.btnDownload.setDisabled(!this.currItem.get('leaf'));
    }
    else {
      this.currItem = null;
      this.V.btnView.setDisabled(true);
      this.V.btnDownload.setDisabled(true);
    }
  },

  viewItem: function(btn) {
    if (this.currItem.get('leaf')) {
      window.open('/BS350/fs/view?f=' + encodeURIComponent(this.currItem.get('id')));
    }
    else {
      this.setPath(this.currItem.get('id'));
    }
  },

  downloadItem: function(btn) {
    window.location.href = '/BS350/fs/download?f=' + encodeURIComponent(this.currItem.get('id'));
  },

  checkDocPath: function() {
    var me = this;
    Ext.Ajax.request(
      {
        url: '/BS350/fs/checkDocDir',
        method: 'GET',
        params: {node: me.rootPath},
        success: function(res)
        {
          var found = Ext.JSON.decode(res.responseText);
          if (found.length === 0)
          {
            me.lastFileNum = -1;
            me.V.noDocDirMsg.setVisible(true);
            me.V.docsPanel.setVisible(false);
            me.V.noSDMsg.setVisible(false);
            me.V.emptyDocDirMsg.setVisible(false);
          }
          else
          {
            me.rootPath += "/documentation";
            if (parseInt(found) !== me.lastFileNum)
            {
              me.loadDocs(me.rootPath);
              me.lastFileNum = parseInt(found);
            }
          }
        }
      }
    );
  },

  checkSD: function() {
    var me = this;
    if (!me.SDMonitoring) return;
    Ext.Ajax.request(
      {
        url: '/BS350/fs/sdPathList',
        method: 'GET',
        success: function(res)
        {
          var pathList = Ext.JSON.decode(res.responseText);
          if (me.rootPath === null && pathList.length > 0)
          {
            me.rootPath = pathList;
            me.checkDocPath();
          }
          else if(me.rootPath !== null && pathList.length === 0) {
            me.rootPath = null;
            me.lastFileNum = -1;
            me.V.noSDMsg.setVisible(true);
            me.V.docsPanel.setVisible(false);
            me.V.noDocDirMsg.setVisible(false);
            me.V.emptyDocDirMsg.setVisible(false);
          }
        }
      }
    );
    setTimeout(function() {me.checkSD();}, 2000);
  },

  activated: function() {
    this.SDMonitoring = true;
    this.checkSD();
  },

  deactivated: function() {
    this.SDMonitoring = false;
  }

});

