/*global Ext:false, TR: false, USERNAME: false, BS350: false */
Ext.define('BS350.controller.MembershipCtrl', {
  extend: 'BS350.custom.ViewController',

  views: ['MembershipView', 'BS350.custom.ToggleColumn'],
  stores: ['MembershipStore'],

  items: [
    { name: 'grid', query: '#memberGrid'},
    { name: 'saveBtn', query: '#btnSave', actions: {click: 'save'}},
    { name: 'discardBtn', query: '#btnDiscard', actions: {click: 'discard'} }
  ],

  forceClose: false,

  init: function (application) {
  },

  initView: function () {
    var editPlugin = this.V.grid.plugins[0];
    if (this.access !== 'w') {
      this.view.getDockedItems()[0].hide();
      editPlugin.on('beforeedit', function (e) { return false; });
    } else {
      editPlugin.on('beforeedit', this.isOperationAllowed2, this);
      editPlugin.on('edit', this.checkChanges, this);
    }
    this.forceClose = false;
    this.store = this.V.grid.getStore();
  },

  loadTable: function () {
    var me = this;
    me.groupsWithAccountPerm = [];
    Ext.Ajax.request(
      {
        url: '/BS350/accounts/getgroups',
        success: function (res) {
          var i;
          var ln;
          var groups = Ext.JSON.decode(res.responseText);
          var fields = [];
          Ext.each(groups, function (group) {
            fields.push("" + group.id);
          });

          var origStore = me.store;

          var fieldsMixedCollection = new Ext.util.MixedCollection(false, function (field) { return field.name; });
          fieldsMixedCollection.add(new Ext.data.Field('id'));
          fieldsMixedCollection.add(new Ext.data.Field('username'));
          for (i = 0, ln = fields.length; i < ln; ++i) {
            fieldsMixedCollection.add(new Ext.data.Field({name: fields[i], defaultValue: false}));
          }
          origStore.model.prototype.fields = fieldsMixedCollection;
          origStore.proxy.reader.buildExtractors(true);

          origStore.load({ scope: me, callback: function (records, operation, success) { if (!success) { me.showError(); } } });

          var columns = [ { text: TR('Username'), sortable: true, hideable: false, dataIndex: 'username' } ];
          Ext.each(groups, function (group) {
            columns.push({
              xtype: 'togglecolumn',
              text: group.name,
              dataIndex: '' + group.id,
              sortable: false,
              hideable: false,
              renderer: function (value, meta, record, rowIndex, colIndex, store, view) {
                var col = this.headerCt.getGridColumns()[colIndex];  //this.columns[colIndex];   // WAS USED IN EXTJS << 4.2
                if (!me.isOperationAllowed(null, {record: record, field: col.dataIndex, originalValue: value})) {
                  meta.extraAtt = 'data-qtip="' + TR('Removing your own Permission access is not allowed') + '"';
                  meta.extraAtt += ' style="background-image: url(' + BS350.custom.Utils.addMediaVersion("/static/images/16px/tick_2_box_readonly.png") + ')"';
                } else {
                  meta.extraAtt = "";
                }
                return col.defaultRenderer(value, meta, record);
              }
            });

            if (group.hasAccountPerm) {
              me.groupsWithAccountPerm.push(group.id);
            }
          });
          columns.push({ flex: 0.5, menuDisabled: true });
          me.V.grid.reconfigure(null, columns);

          if (me.access !== 'w') {
            var g = me.V.grid;
            var c;
            for (c in g.columns) { g.columns[c].editable = false; }
          }

          me.V.saveBtn.setDisabled(true);
          me.V.discardBtn.setDisabled(true);
        }
      }
    );
  },

  showError: function () {
    Ext.Msg.show({ title: TR('Groups'), msg: TR('Error retriving data'), buttons: Ext.Msg.OK, icon: Ext.Msg.ERROR });
  },

  save: function () {
    this.store.sync();
    this.V.saveBtn.setDisabled(true);
    this.V.discardBtn.setDisabled(true);
  },

  discard: function () {
    this.store.load();
    this.V.saveBtn.setDisabled(true);
    this.V.discardBtn.setDisabled(true);
  },

  checkChanges: function () {
    var isDirty = this.store.isDirty();
    this.V.saveBtn.setDisabled(!isDirty);
    this.V.discardBtn.setDisabled(!isDirty);
  },

  isOperationAllowed: function (editor, e) {
    var groupId = parseInt(e.field, 10);
    // The user can not removes its "Permission view" write permission
    if (e.record.get('username') === USERNAME && Ext.Array.indexOf(this.groupsWithAccountPerm, groupId) !== -1) {
      var i, allowed = false;
      for (i in this.groupsWithAccountPerm) {
        allowed = allowed || (this.groupsWithAccountPerm[i] === groupId ? !e.originalValue : e.record.get(this.groupsWithAccountPerm[i]));
      }
      return allowed;
    }
    return true;
  },

  isOperationAllowed2: function (editor, e) {
    var groupId = parseInt(e.field, 10);
    // The user can not removes its "Permission view" write permission
    if (e.record.get('username') === USERNAME && Ext.Array.indexOf(this.groupsWithAccountPerm, groupId) !== -1) {
      var i;
      for (i in this.groupsWithAccountPerm) {
        if (this.groupsWithAccountPerm[i] === groupId)
        {
          return (!e.record.get(this.groupsWithAccountPerm[i]));
        }
      }
    }
    return true;
  },

  askclose: function (panel) {
    var me = this;
    if ((me.store.isDirty()) && !me.forceClose) {
      Ext.Msg.show({
        title: TR('Save changes?'),
        msg: TR('Do you want to save the changes?'),
        buttons: Ext.Msg.YESNOCANCEL,
        fn: function (btn) {
          if (btn === 'yes') {me.forceClose = true; me.store.sync({callback: function () {panel.close(); }}); }
          if (btn === 'no') { me.forceClose = true; panel.close(); }
        },
        icon: Ext.Msg.QUESTION
      });
      return false;
    }
    return true;
  },

  activated: function () {
    this.loadTable();
  }

});

