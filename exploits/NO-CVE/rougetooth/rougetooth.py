#!/usr/bin/python3

import sys
import os
import time
from bthid import BluetoothHIDService
from Xlib import X, display, Xutil
from dbus.mainloop.glib import DBusGMainLoop

#macaddr = "DC:53:60:6C:FC:B3"
macaddr = sys.argv[1]


def macr(send_call_back):
    time.sleep(5)
    kbd_state = bytearray([0xA1, 0x01, 0x00, 0x00, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00])
    time.sleep(1)
    send_call_back(bytes(kbd_state))
    kbd_state = bytearray([0xA1, 0x01, 0x00, 0x00, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00])
    time.sleep(1)
    send_call_back(bytes(kbd_state))
    kbd_state = bytearray([0xA1, 0x01, 0x00, 0x00, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00])
    time.sleep(11)
    send_call_back(bytes(kbd_state))
    kbd_state = bytearray([0xA1, 0x01, 0x00, 0x00, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00])
    time.sleep(1)
    send_call_back(bytes(kbd_state))
    kbd_state = bytearray([0xA1, 0x01, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00])
    time.sleep(1)
    send_call_back(bytes(kbd_state))
    kbd_state = bytearray([0xA1, 0x01, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00])
    time.sleep(1)
    send_call_back(bytes(kbd_state))
    kbd_state = bytearray([0xA1, 0x01, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00])
    time.sleep(1)
    send_call_back(bytes(kbd_state))

if __name__ == '__main__':
    DBusGMainLoop(set_as_default=True)
    srec = open("sdp_record_kbd.xml").read()
    try:
        bthid_srv = BluetoothHIDService(srec, macaddr)
        macr(bthid_srv.send)
    finally:
        print("Done")
