#!/bin/sh

loggerName=start-dhcp-manual-sh
IF=eth0

ifconfig $IF down &> /dev/null
if [ "$?" -ne "0" ]; then
   logger -s -t hotplug-eth0 "kein Adapter <$IF> angeschlossen -> Exit"
   exit 
fi 
sleep 1

ifconfig $IF up &> /dev/null

PID=`ps | grep "[u]dhcpc -i eth0" | awk '{print $1}'`
kill -SIGUSR2 $PID &> /dev/null
kill -SIGTERM $PID &> /dev/null

name=`hostname`
#udhcpc -i $IF -S --hostname=$name -s /etc/udhcpc/simple.script &
#udhcpc -i $IF -S -x hostname=$name -s /etc/udhcpc/simple.script &
udhcpc -i $IF -S -s /etc/udhcpc/simple.script &

if [ "$?" -eq "0" ]; then
   logger -s -t $loggerName "Info: start udhcpc-client success hostname<$name>"
else 
   logger -s -t $loggerName "Err: start udhcpc-client false hostname<$name>"
fi

var0=0
limit=15

while [ "$var0" -lt "$limit" ]
  do 
    ifconfig $IF | grep 'inet addr'
    if [ "$?" -eq "0" ]; then
       IpAdr=`ifconfig $IF | grep inet | awk '{print $2}' | cut -d: -f2`
       logger -s -t $loggerName "IP-Adresse ($IpAdr) voM DHCP Server bekommen -> Exit"
       exit       
    fi
    sleep 1
    var0=`expr $var0 + 1`
 done

PID=`ps | grep "[u]dhcpc -i eth0" | awk '{print $1}'`
kill -SIGUSR2 $PID &> /dev/null
kill -SIGTERM $PID &> /dev/null

logger -s -t $loggerName "manuelle IP Adresse 192.168.1.10"  
# ist wlan aktiv und im gleich subnetz?
ifconfig tiwlan0 | grep inet | awk '{print $2}' | cut -d: -f2 | grep 192.168.1
if [ "$?" -eq "0" ]; then
  # ja, dann zusätzliche host routen für 192.168.1.1 bis 192.168.1.9 anlegen
  route add -host 192.168.1.1 $IF
  route add -host 192.168.1.2 $IF
  route add -host 192.168.1.3 $IF
  route add -host 192.168.1.4 $IF
  route add -host 192.168.1.5 $IF
  route add -host 192.168.1.6 $IF
  route add -host 192.168.1.7 $IF
  route add -host 192.168.1.8 $IF
  route add -host 192.168.1.9 $IF
fi

ifconfig $IF 192.168.1.10 netmask 255.255.255.0 up


