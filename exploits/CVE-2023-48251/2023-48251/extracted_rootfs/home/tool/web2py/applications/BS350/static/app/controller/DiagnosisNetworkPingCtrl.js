/**
 * Created by frank on 6/17/15.
 */
/*global Ext: false, BS350: false, TR: false, window: false */
Ext.define('BS350.controller.DiagnosisNetworkPingCtrl', {
  extend: 'BS350.custom.ViewController',
  views: ['DiagnosisNetworkPingView'],
  items: [
    { name: 'btnStart', query: '#btnStart', actions: { click: 'pingStart'}},
    { name: 'btnStop', query: '#btnStop', actions: { click: 'pingStop'}},
    { name: 'btnClear', query: '#btnClear', actions: { click: 'clearOutput'}},
    { name: 'ping_result_active', query: '#ping_result_active' },
    { name: 'ping_target_img', query: '#ping_target_img' },
    { name: 'ping_target_msg', query: '#ping_target_msg' },
    { name: 'ping_target', query: '#ping_target' },
    { name: 'ping_result', query: '#ping_result' },
    { name: 'result_panel', query: '#result_panel' },
    { name: 'msg_lbl_bbar', query: '#msg_lbl_bbar'}
  ],
  stopPing: true,
  init: function (application) {
    var me = this;
  },
  initView: function () {
    var me = this;
    me.V.btnStart.setDisabled(false);
    me.V.btnStop.setDisabled(true);
    me.V.btnClear.setDisabled(false);
  },
  clearOutput: function () {
    var me = this;
    me.V.ping_result.setText("");
  },
  pingStart: function () {
    var me = APP.getController("DiagnosisNetworkPingCtrl");
    me.V.msg_lbl_bbar.setText("");
    me.V.ping_target_msg.setText('');
    me.stopPing = false;
    me.V.btnStart.setDisabled(true);
    me.V.btnStop.setDisabled(false);
    me.__innerPing();
  },
  __innerPing: function () {
    try {
      var me = APP.getController("DiagnosisNetworkPingCtrl");
      var ping_target = "";
      if (me.V !== undefined && me.V.ping_target !== undefined) {
        ping_target = me.V.ping_target.value;
      }
    } catch (e) {
      // pass
    }
    Ext.Ajax.request({
      url: "BS350/network/ping",
      method: "GET",
      scope: me,
      params: { ping_target: ping_target },
      timeout: 2500,
      success: function (response) {
        var me = APP.getController("DiagnosisNetworkPingCtrl");
        var json = Ext.JSON.decode(response.responseText);
        if (json.success !== true) {
          me.V.ping_target_img.setSrc(BS350.custom.Utils.addMediaVersion('BS350/static/images/24px/led_red.png'));
          me.V.ping_target_msg.setText(json.msg);
          me.stopPing = true;
          me.V.btnStop.setDisabled(true);
        }
        var value = "";
        if (
          me.V !== undefined &&
          me.V.ping_result !== undefined &&
          me.V.ping_result_active.getValue() === true &&
          me.V.ping_result.html !== undefined &&
          me.V.ping_result.html !== ""
        ) {
          value = me.V.ping_result.html + "<br/><br/>" + json.msg;
        } else if (me.V.ping_result_active.getValue() === false) {
          value = "";
        } else {
          value = json.msg;
        }
        if (me.V !== undefined) {
          me.V.ping_result.setText(value, false);
          me.V.result_panel.scrollBy(0, 10000, true);
        }
        if (me.stopPing === false) {
          me.V.ping_target_msg.setText('');
          if (json.led === "red") {
            me.V.ping_target_img.setSrc(BS350.custom.Utils.addMediaVersion('BS350/static/images/24px/led_red.png'));
          } else if (json.led === "green") {
            me.V.ping_target_img.setSrc(BS350.custom.Utils.addMediaVersion('BS350/static/images/24px/led_green.png'));
          }
          setTimeout(me.__innerPing, 1000);
          if (me.V !== undefined) {
            me.V.btnStop.setDisabled(false);
          }
        } else {
          if (me.V !== undefined) {
            me.V.btnStart.setDisabled(false);
            /* we are just stopping, led is left as is. */
            //me.V.ping_target_img.setSrc(BS350.custom.Utils.addMediaVersion('BS350/static/images/24px/led_red.png'));
          }
        }
      },
      failure: function () {
        var me = this;
        me.stopPing = true;
        if (me.V !== undefined) {
          me.V.ping_target_img.setSrc(BS350.custom.Utils.addMediaVersion('BS350/static/images/24px/led_red.png'));
          me.V.msg_lbl_bbar.setText(TR("Timeout reached, ping stopped"));
          me.V.ping_target_msg.setText(TR("Timeout reached, ping stopped"));
          me.V.btnStop.setDisabled(true);
          me.V.btnStart.setDisabled(false);
        }
      }
    });
  },
  pingStop: function () {
    var me = this;
    me.stopPing = true;
    me.V.btnStart.setDisabled(false);
    me.V.btnStop.setDisabled(true);
  }
});
